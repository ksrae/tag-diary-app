<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Serena Memory Dashboard</title>
  <style>
    :root {
      --bg: #0f0b1a;
      --surface: #1a1428;
      --surface-2: #241e33;
      --border: #3d2e5c;
      --purple: #9b59b6;
      --purple-light: #c39bd3;
      --purple-dark: #6c3483;
      --text: #e8e0f0;
      --text-dim: #8a7da0;
      --green: #2ecc71;
      --red: #e74c3c;
      --yellow: #f1c40f;
      --cyan: #1abc9c;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;
      min-height: 100vh;
      padding: 24px;
    }

    .header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 24px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
    }

    .logo {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--purple), var(--purple-dark));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      font-weight: bold;
      color: white;
    }

    .header-text h1 {
      font-size: 20px;
      color: var(--purple-light);
    }

    .header-text .subtitle {
      font-size: 12px;
      color: var(--text-dim);
    }

    .connection-badge {
      margin-left: auto;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .connection-badge.connected {
      background: rgba(46, 204, 113, 0.15);
      color: var(--green);
      border: 1px solid rgba(46, 204, 113, 0.3);
    }
    .connection-badge.disconnected {
      background: rgba(231, 76, 60, 0.15);
      color: var(--red);
      border: 1px solid rgba(231, 76, 60, 0.3);
    }
    .connection-badge.connecting {
      background: rgba(241, 196, 15, 0.15);
      color: var(--yellow);
      border: 1px solid rgba(241, 196, 15, 0.3);
    }

    .session-bar {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .session-id {
      font-size: 14px;
      font-weight: 600;
    }

    .session-status {
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .session-status.running {
      background: rgba(46, 204, 113, 0.15);
      color: var(--green);
    }
    .session-status.completed {
      background: rgba(26, 188, 156, 0.15);
      color: var(--cyan);
    }
    .session-status.failed {
      background: rgba(231, 76, 60, 0.15);
      color: var(--red);
    }
    .session-status.unknown {
      background: rgba(138, 125, 160, 0.15);
      color: var(--text-dim);
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }

    .card-header {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 13px;
      font-weight: 600;
      color: var(--purple-light);
      background: var(--surface-2);
    }

    .card-body {
      padding: 16px;
    }

    .agent-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .agent-table th {
      text-align: left;
      padding: 8px 12px;
      color: var(--text-dim);
      font-weight: 500;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    .agent-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(61, 46, 92, 0.4);
    }

    .agent-table tr:last-child td {
      border-bottom: none;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: 6px;
    }
    .status-dot.running { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.completed { background: var(--cyan); }
    .status-dot.failed { background: var(--red); }
    .status-dot.blocked { background: var(--yellow); }
    .status-dot.pending { background: var(--text-dim); }

    .status-text {
      font-size: 12px;
    }

    .activity-list {
      list-style: none;
      font-size: 12px;
    }

    .activity-list li {
      padding: 8px 0;
      border-bottom: 1px solid rgba(61, 46, 92, 0.3);
      display: flex;
      gap: 8px;
    }

    .activity-list li:last-child {
      border-bottom: none;
    }

    .activity-agent {
      color: var(--purple-light);
      font-weight: 600;
      white-space: nowrap;
    }

    .activity-msg {
      color: var(--text-dim);
    }

    .empty {
      color: var(--text-dim);
      font-size: 12px;
      font-style: italic;
      padding: 12px 0;
    }

    .footer {
      margin-top: 20px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-dim);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .pulse { animation: pulse 2s ease-in-out infinite; }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">S</div>
    <div class="header-text">
      <h1>Serena Memory Dashboard</h1>
      <div class="subtitle">Real-time agent orchestration monitor</div>
    </div>
    <div class="connection-badge connecting" id="connBadge">Connecting...</div>
  </div>

  <div class="session-bar">
    <span>Session:</span>
    <span class="session-id" id="sessionId">N/A</span>
    <span class="session-status unknown" id="sessionStatus">UNKNOWN</span>
    <span style="margin-left:auto; font-size:11px; color:var(--text-dim)" id="updatedAt">--</span>
  </div>

  <div class="grid">
    <div class="card">
      <div class="card-header">Agent Status</div>
      <div class="card-body">
        <table class="agent-table">
          <thead>
            <tr><th>Agent</th><th>Status</th><th>Turn</th><th>Task</th></tr>
          </thead>
          <tbody id="agentBody">
            <tr><td colspan="4" class="empty">No agents detected yet</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <div class="card-header">Latest Activity</div>
      <div class="card-body">
        <ul class="activity-list" id="activityList">
          <li class="empty">No activity yet</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="footer">
    <span>Serena Memory Dashboard</span>
    <span id="footerTime">--</span>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);

    function normalizeStatus(s) {
      const lower = (s || '').toLowerCase();
      if (['running', 'active', 'in_progress', 'in-progress'].includes(lower)) return 'running';
      if (['completed', 'done', 'finished'].includes(lower)) return 'completed';
      if (['failed', 'error'].includes(lower)) return 'failed';
      if (['blocked', 'waiting'].includes(lower)) return 'blocked';
      return 'pending';
    }

    function statusLabel(s) {
      return normalizeStatus(s);
    }

    // Safe DOM builder helpers â€” no innerHTML usage
    function clearChildren(el) {
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    function createTextEl(tag, text, className) {
      const el = document.createElement(tag);
      el.textContent = text;
      if (className) el.className = className;
      return el;
    }

    function renderAgents(agents) {
      const tbody = $('#agentBody');
      clearChildren(tbody);

      if (!agents || agents.length === 0) {
        const tr = document.createElement('tr');
        const td = createTextEl('td', 'No agents detected yet', 'empty');
        td.setAttribute('colspan', '4');
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      agents.forEach(function(a) {
        const ns = normalizeStatus(a.status);
        const tr = document.createElement('tr');

        // Agent name
        tr.appendChild(createTextEl('td', a.agent));

        // Status cell with dot + text
        const statusTd = document.createElement('td');
        const dot = document.createElement('span');
        dot.className = 'status-dot ' + ns + (ns === 'running' ? ' pulse' : '');
        statusTd.appendChild(dot);
        statusTd.appendChild(createTextEl('span', statusLabel(a.status), 'status-text'));
        tr.appendChild(statusTd);

        // Turn
        tr.appendChild(createTextEl('td', a.turn != null ? String(a.turn) : '-'));

        // Task
        tr.appendChild(createTextEl('td', a.task || ''));

        tbody.appendChild(tr);
      });
    }

    function renderActivity(activity) {
      const list = $('#activityList');
      clearChildren(list);

      if (!activity || activity.length === 0) {
        list.appendChild(createTextEl('li', 'No activity yet', 'empty'));
        return;
      }

      activity.forEach(function(a) {
        const li = document.createElement('li');
        li.appendChild(createTextEl('span', '[' + a.agent + ']', 'activity-agent'));
        li.appendChild(createTextEl('span', a.message, 'activity-msg'));
        list.appendChild(li);
      });
    }

    function renderState(state) {
      // Session
      $('#sessionId').textContent = state.session?.id || 'N/A';
      const st = (state.session?.status || 'UNKNOWN').toUpperCase();
      const statusEl = $('#sessionStatus');
      statusEl.textContent = st;
      statusEl.className = 'session-status ' + st.toLowerCase();

      // Updated at
      if (state.updatedAt) {
        const d = new Date(state.updatedAt);
        const ts = d.toLocaleString();
        $('#updatedAt').textContent = 'Updated: ' + ts;
        $('#footerTime').textContent = ts;
      }

      // Agents & Activity
      renderAgents(state.agents);
      renderActivity(state.activity);
    }

    // --- WebSocket ---
    var ws;
    var reconnectDelay = 1000;

    function connect() {
      var badge = $('#connBadge');
      badge.textContent = 'Connecting...';
      badge.className = 'connection-badge connecting';

      var protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(protocol + '//' + location.host);

      ws.onopen = function() {
        badge.textContent = 'Connected';
        badge.className = 'connection-badge connected';
        reconnectDelay = 1000;
      };

      ws.onmessage = function(evt) {
        try {
          var msg = JSON.parse(evt.data);
          if (msg.data) renderState(msg.data);
        } catch (e) { /* ignore parse errors */ }
      };

      ws.onclose = function() {
        badge.textContent = 'Disconnected';
        badge.className = 'connection-badge disconnected';
        setTimeout(function() {
          reconnectDelay = Math.min(reconnectDelay * 1.5, 10000);
          connect();
        }, reconnectDelay);
      };

      ws.onerror = function() {
        ws.close();
      };
    }

    // Initial fetch via HTTP, then switch to WebSocket
    fetch('/api/state')
      .then(function(r) { return r.json(); })
      .then(renderState)
      .catch(function() {});

    connect();
  </script>
</body>
</html>
