experimental_monorepo_root = true

[settings]
experimental = true

[tools]
node = "24"
python = "3.13"
pnpm = "10"
uv = "latest"
flutter = "3"
terraform = "1"
hadolint = "latest"
"github:Infisical/cli" = "latest"

[tasks]
dev = { depends = ["//apps/api:dev", "//apps/web:dev", "//apps/worker:dev"], description = "Start all services" }
lint = { depends = ["//apps/api:lint", "//apps/web:lint", "//apps/worker:lint"], description = "Lint all apps" }
format = { depends = ["//apps/api:format", "//apps/web:format", "//apps/worker:format"], description = "Format all apps" }
test = { depends = ["//apps/api:test", "//apps/web:test", "//apps/worker:test"], description = "Test all apps" }
typecheck = { depends = ["//apps/api:typecheck", "//apps/web:typecheck"], description = "Type check all apps" }
"i18n:build" = { depends = ["//packages/i18n:build"], description = "Build i18n files" }
"gen:api" = { run = "mise //apps/api:gen:openapi && mise //apps/web:gen:api", description = "Generate OpenAPI schema and API clients" }
"infra:up" = { depends = ["//apps/api:infra:up"], description = "Start local infrastructure" }
"infra:down" = { depends = ["//apps/api:infra:down"], description = "Stop local infrastructure" }

[tasks."git:commit-msg"]
description = "Validate commit message using commitlint"
run = "pnpm dlx @commitlint/cli@20 --edit $1"

[tasks."git:pre-commit"]
description = "Run conditional checks for staging files"
run = '''
#!/usr/bin/env bash
changed=$(git diff --cached --name-only)

if echo "$changed" | grep -q "^apps/api/"; then
    echo "[pre-commit] apps/api detected, running lint..."
    mise //apps/api:lint || exit 1
fi

if echo "$changed" | grep -q "^apps/web/"; then
    echo "[pre-commit] apps/web detected, running lint..."
    mise //apps/web:lint || exit 1
fi

if echo "$changed" | grep -q "^apps/worker/"; then
    echo "[pre-commit] apps/worker detected, running lint..."
    mise //apps/worker:lint || exit 1
fi

if echo "$changed" | grep -q "^apps/mobile/"; then
    echo "[pre-commit] apps/mobile detected, running lint..."
    mise //apps/mobile:lint || exit 1
fi

if echo "$changed" | grep -qE "Dockerfile$"; then
    echo "[pre-commit] Dockerfile detected, running hadolint..."
    echo "$changed" | grep -E "Dockerfile$" | xargs hadolint || exit 1
fi
'''
